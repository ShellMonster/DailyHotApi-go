# Docker 镜像发布指南

## 概述

本指南说明如何将 DailyHotApi-Go 打包成 Docker 镜像，并推送到 Docker Hub 或其他容器注册表，供其他人使用 `docker run` 命令直接运行。

---

## 步骤 1️⃣：构建本地镜像

### 前置条件
- 已安装 Docker（[安装指南](https://docs.docker.com/get-docker/)）
- 项目根目录中有 Dockerfile 和 go.mod

### 构建镜像命令

```bash
# 进入项目目录
cd DailyHotApi-Go

# 构建镜像
# 格式: docker build -t [镜像名称]:[标签] .
# 示例:
docker build -t dailyhot-api-go:1.0.0 .

# 或者使用最新标签
docker build -t dailyhot-api-go:latest .
```

### 验证镜像是否构建成功

```bash
# 列出本地镜像
docker images | grep dailyhot-api-go

# 预期输出:
# REPOSITORY        TAG       IMAGE ID       CREATED         SIZE
# dailyhot-api-go   1.0.0     abc123...      5 minutes ago   50MB
# dailyhot-api-go   latest    abc123...      5 minutes ago   50MB
```

---

## 步骤 2️⃣：本地测试运行

在推送前，建议先在本地测试镜像是否能正常运行：

```bash
# 基本运行（无配置）
docker run -p 6688:6688 dailyhot-api-go:1.0.0

# 带配置文件运行
docker run -p 6688:6688 \
  -v /path/to/config.yaml:/app/config.yaml \
  dailyhot-api-go:1.0.0

# 后台运行
docker run -d -p 6688:6688 \
  --name dailyhot \
  dailyhot-api-go:1.0.0

# 查看运行日志
docker logs dailyhot

# 测试 API 是否可用
curl http://localhost:6688/health
```

---

## 步骤 3️⃣：推送到 Docker Hub

### 3.1 创建 Docker Hub 账户
- 访问 [Docker Hub](https://hub.docker.com/)
- 注册账户（你的用户名为 `ShellMonster`）

### 3.2 登录 Docker

```bash
docker login

# 输入用户名和密码（或访问令牌）
# Username: ShellMonster
# Password: ••••••••••••••••••
```

### 3.3 给镜像打标签

标签格式：`docker_username/repository_name:tag`

```bash
# 给镜像重新标记为 Docker Hub 格式
# 格式: docker tag [本地镜像名]:[标签] [Docker用户名]/[仓库名]:[标签]

docker tag dailyhot-api-go:1.0.0 ShellMonster/dailyhot-api-go:1.0.0
docker tag dailyhot-api-go:1.0.0 ShellMonster/dailyhot-api-go:latest

# 验证标签
docker images | grep ShellMonster/dailyhot-api-go
```

### 3.4 推送镜像到 Docker Hub

```bash
# 推送特定版本
docker push ShellMonster/dailyhot-api-go:1.0.0

# 推送 latest 标签（最新版本）
docker push ShellMonster/dailyhot-api-go:latest
```

推送完成后，你会在 Docker Hub 上看到这个镜像：
`https://hub.docker.com/r/ShellMonster/dailyhot-api-go`

---

## 步骤 4️⃣：其他人如何使用你的镜像

### 4.1 拉取镜像

```bash
docker pull ShellMonster/dailyhot-api-go:1.0.0

# 或拉取最新版本
docker pull ShellMonster/dailyhot-api-go:latest
```

### 4.2 运行镜像

```bash
# 简单运行
docker run -p 6688:6688 ShellMonster/dailyhot-api-go:1.0.0

# 使用 docker-compose 运行
cat > docker-compose.yml << 'EOF'
version: '3.8'
services:
  api:
    image: ShellMonster/dailyhot-api-go:1.0.0
    ports:
      - "6688:6688"
    environment:
      - DAILYHOT_SERVER_PORT=6688
      - DAILYHOT_REDIS_ENABLED=false
    volumes:
      - ./config.yaml:/app/config.yaml
    restart: unless-stopped
EOF

docker-compose up -d
```

---

## 步骤 5️⃣：使用其他 Registry（可选）

### 5.1 推送到阿里云（中国内地）

```bash
# 1. 登录阿里云
docker login --username=your_aliyun_username registry.cn-hangzhou.aliyuncs.com

# 2. 给镜像打标签
docker tag dailyhot-api-go:1.0.0 registry.cn-hangzhou.aliyuncs.com/ShellMonster/dailyhot-api-go:1.0.0

# 3. 推送
docker push registry.cn-hangzhou.aliyuncs.com/ShellMonster/dailyhot-api-go:1.0.0
```

### 5.2 推送到 GitHub Container Registry

```bash
# 1. 创建 GitHub 访问令牌（Settings > Developer settings > Personal access tokens）
# 2. 登录
echo $YOUR_TOKEN | docker login ghcr.io -u ShellMonster --password-stdin

# 3. 给镜像打标签
docker tag dailyhot-api-go:1.0.0 ghcr.io/ShellMonster/dailyhot-api-go:1.0.0

# 4. 推送
docker push ghcr.io/ShellMonster/dailyhot-api-go:1.0.0
```

---

## 最佳实践 ✅

### 版本管理

```bash
# 为每个发布版本创建不同的标签
docker tag dailyhot-api-go:1.0.0 ShellMonster/dailyhot-api-go:1.0.0
docker tag dailyhot-api-go:1.0.0 ShellMonster/dailyhot-api-go:v1.0
docker tag dailyhot-api-go:1.0.0 ShellMonster/dailyhot-api-go:latest

docker push ShellMonster/dailyhot-api-go:1.0.0
docker push ShellMonster/dailyhot-api-go:v1.0
docker push ShellMonster/dailyhot-api-go:latest
```

### 使用 docker-compose.yml

创建完整的部署配置供其他人使用：

```yaml
version: '3.8'

services:
  api:
    image: ShellMonster/dailyhot-api-go:latest
    container_name: dailyhot-api
    ports:
      - "6688:6688"
    environment:
      - DAILYHOT_SERVER_PORT=6688
      - DAILYHOT_LOG_LEVEL=info
      - DAILYHOT_REDIS_ENABLED=false
    volumes:
      - ./config.yaml:/app/config.yaml
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:6688/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  # 可选：添加 Redis
  redis:
    image: redis:7-alpine
    container_name: dailyhot-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped

volumes:
  redis-data:
```

### 镜像大小优化

当前 Dockerfile 已经优化了：
- ✅ 多阶段构建（只包含最终二进制文件）
- ✅ Alpine 基础镜像（轻量级）
- ✅ 去除调试信息（`-ldflags="-s -w"`）
- ✅ 静态编译（`CGO_ENABLED=0`）

预期镜像大小：**~50MB**

---

## 命令速查表

| 操作 | 命令 |
|------|------|
| 构建镜像 | `docker build -t dailyhot-api-go:1.0.0 .` |
| 本地运行 | `docker run -p 6688:6688 dailyhot-api-go:1.0.0` |
| 登录 Docker Hub | `docker login` |
| 标记镜像 | `docker tag dailyhot-api-go:1.0.0 ShellMonster/dailyhot-api-go:1.0.0` |
| 推送到 Docker Hub | `docker push ShellMonster/dailyhot-api-go:1.0.0` |
| 拉取镜像 | `docker pull ShellMonster/dailyhot-api-go:1.0.0` |
| 列出本地镜像 | `docker images` |
| 查看运行日志 | `docker logs container_id` |
| 停止容器 | `docker stop container_id` |
| 删除镜像 | `docker rmi image_id` |

---

## 常见问题

### Q: 镜像构建失败，提示找不到依赖？
**A:** 可能是网络问题。尝试修改 `Dockerfile` 中的 GOPROXY：
```dockerfile
# 国内:
ENV GOPROXY=https://goproxy.cn,direct
# 国际:
ENV GOPROXY=https://proxy.golang.org,direct
```

### Q: 镜像运行后无法访问 API？
**A:** 检查端口映射：
```bash
# 正确的映射
docker run -p 6688:6688 ShellMonster/dailyhot-api-go:1.0.0

# 验证容器是否运行
docker ps | grep dailyhot-api-go
```

### Q: 如何在生产环境使用？
**A:** 使用 docker-compose 或 Kubernetes：
```bash
# docker-compose
docker-compose up -d

# 或者 Kubernetes
kubectl apply -f deployment.yaml
```

### Q: 如何更新镜像？
**A:** 修改代码后重新构建和推送：
```bash
# 修改代码...
git add .
git commit -m "Update features"

# 构建新版本
docker build -t dailyhot-api-go:1.0.1 .

# 打标签并推送
docker tag dailyhot-api-go:1.0.1 ShellMonster/dailyhot-api-go:1.0.1
docker push ShellMonster/dailyhot-api-go:1.0.1
```

---

## 下一步

1. ✅ 在本地构建并测试镜像
2. 📤 创建 Docker Hub 账户并推送
3. 📋 创建 README.md 说明如何使用你的镜像
4. 🚀 分享镜像 URL 给其他开发者

